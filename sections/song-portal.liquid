{{ 'section-song-portal.css' | asset_url | stylesheet_tag: preload: true }}
<style>
  /* NUCLEAR OPTION: INLINE STYLES TO BYPASS CACHE */
  .status-tracker__steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-bottom: 2rem;
    padding: 0 1rem;
  }
  .status-tracker__steps::before {
    content: '';
    position: absolute;
    top: 15px;
    left: 2rem;
    right: 2rem;
    height: 2px;
    background: rgba(255, 255, 255, 0.1);
    z-index: 0;
  }
  @media (max-width: 768px) {
    .status-tracker__steps {
      justify-content: flex-start;
      overflow-x: auto;
      padding-bottom: 1.5rem;
      gap: 2rem;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .status-tracker__steps::-webkit-scrollbar { display: none; }
    .status-tracker__steps::before { width: 100%; left: 0; right: 0; }
    .status-step { flex: 0 0 auto; width: 100px; }
  }
  .approval-feedback--success {
    background: rgba(212, 175, 55, 0.1) !important;
    border: 1px solid rgba(212, 175, 55, 0.3) !important;
    color: #d4af37 !important; /* Gold */
    font-family: var(--font-heading);
    font-size: 1.1rem;
    text-align: center;
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.1);
    display: block !important;
  }
</style>
<script src="{{ 'song-portal.js' | asset_url }}?v={{ 'now' | date: '%s' }}" defer="defer"></script>

<section class="song-portal-section">
  <div class="song-portal__container">
    <header class="song-portal__header">
      <h1 class="song-portal__title">{{ section.settings.heading }}</h1>
      {% if section.settings.subheading != blank %}
        <p class="song-portal__subtitle">{{ section.settings.subheading }}</p>
      {% endif %}
    </header>

    {% if section.settings.intro_text != blank %}
      <p class="song-portal__intro">{{ section.settings.intro_text }}</p>
    {% endif %}

    {% unless customer %}
      <div class="song-portal__state-card">
        <h2 class="song-portal__state-title">Please Log In</h2>
        <p class="song-portal__state-text">You must be logged in to view your song portal.</p>
        <a href="{{ routes.account_login_url }}" class="btn-portal">Log In</a>
      </div>
    {% else %}
      {% assign commission_count = 0 %}
      {% for order in customer.orders %}
        {% assign is_commission = false %}
        {% for line_item in order.line_items %}
          {% if line_item.product.type == 'Bespoke Song' or line_item.product.tags contains 'bespoke-song' %}
            {% assign is_commission = true %}
            {% break %}
          {% endif %}
        {% endfor %}
        
        {% comment %}Fallback: treat all orders as commissions if not strictly filtered{% endcomment %}
        {% if is_commission == false and order.line_items.size > 0 %}
           {% assign is_commission = true %}
        {% endif %}

        {% if is_commission %}
          {% assign commission_count = commission_count | plus: 1 %}
          {% render 'song-portal-card', order: order, blocks: section.blocks %}
        {% endif %}
      {% endfor %}

      {% if commission_count == 0 %}
        <div class="song-portal__state-card">
          <h2 class="song-portal__state-title">No Active Commissions</h2>
          <p class="song-portal__state-text">{{ section.settings.empty_state_text }}</p>
          <a href="{{ routes.all_products_collection_url }}" class="btn-portal">Browse Songs</a>
        </div>
      {% endif %}
    {% endunless %}
  </div>
</section>

{% schema %}
{
  "name": "Song Portal",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Your Song Portal"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Where your story becomes song."
    },
    {
      "type": "textarea",
      "id": "intro_text",
      "label": "Intro Text",
      "default": "Welcome to your bespoke song hub. Track your songâ€™s progress, read updates from me, and preview your track before final delivery."
    },
    {
      "type": "textarea",
      "id": "empty_state_text",
      "label": "Empty State Text",
      "default": "Once you purchase a bespoke song, your personal portal will appear here with status updates, previews, and your final download."
    }
  ],
  "blocks": [
    {
      "type": "step",
      "name": "Status Step",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Step Title",
          "default": "Order Received"
        },
        {
          "type": "text",
          "id": "handle",
          "label": "Status Handle (Metafield Value)",
          "default": "order_received",
          "info": "Must match the value in custom.song_portal_status"
        },
        {
          "type": "range",
          "id": "progress",
          "label": "Progress Percentage",
          "min": 0,
          "max": 100,
          "step": 5,
          "default": 10
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Song Portal",
      "blocks": [
        {
          "type": "step",
          "settings": {
            "title": "Order Received",
            "handle": "order_received",
            "progress": 10
          }
        },
        {
          "type": "step",
          "settings": {
            "title": "Initial Consultation",
            "handle": "initial_consultation",
            "progress": 20
          }
        },
        {
          "type": "step",
          "settings": {
            "title": "Working on Lyrics",
            "handle": "writing_lyrics",
            "progress": 35
          }
        },
        {
          "type": "step",
          "settings": {
            "title": "Lyrics Ready",
            "handle": "lyrics_ready_for_review",
            "progress": 50
          }
        },
        {
          "type": "step",
          "settings": {
            "title": "Lyrics Approved",
            "handle": "lyrics_approved",
            "progress": 65
          }
        },
        {
          "type": "step",
          "settings": {
            "title": "Working on Music",
            "handle": "producing_music",
            "progress": 80
          }
        },
        {
          "type": "step",
          "settings": {
            "title": "Music Ready",
            "handle": "music_ready_for_review",
            "progress": 90
          }
        },
        {
          "type": "step",
          "settings": {
            "title": "Final Delivery",
            "handle": "final_delivery",
            "progress": 100
          }
        }
      ]
    }
  ]
}
{% endschema %}
