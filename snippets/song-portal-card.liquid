{% comment %}
  Renders a Song Portal Card for a specific order.
  Accepts:
  - order: The Order object.
  - blocks: The section blocks defining the status steps.
{% endcomment %}

{% assign commission_item = nil %}
{% for line_item in order.line_items %}
  {% if line_item.product.type == 'Bespoke Song' or line_item.product.tags contains 'bespoke-song' %}
    {% assign commission_item = line_item %}
    {% break %}
  {% endif %}
{% endfor %}

{% if commission_item == nil %}
  {% assign commission_item = order.line_items.first %}
{% endif %}

{% comment %} Metafield Logic {% endcomment %}
{% assign status_metafield = order.metafields.custom.song_portal_status | default: order.metafields.song_portal.status %}
{% assign status_message = order.metafields.custom.status_message | default: order.metafields.song_portal.status_message %}
{% assign preview_audio = order.metafields.custom.preview_audio | default: order.metafields.song_portal.preview_audio %}
{% assign final_audio = order.metafields.custom.final_audio | default: order.metafields.song_portal.final_audio %}
{% assign final_approved = order.metafields.custom.final_approved | default: order.metafields.song_portal.final_approved %}

{% comment %} Normalize Status {% endcomment %}
{% assign current_status_handle = status_metafield | downcase | replace: ' ', '_' | default: 'order_received' %}

{% comment %} Calculate Progress based on Blocks {% endcomment %}
{% assign current_step_index = 0 %}
{% assign total_steps = 0 %}
{% assign progress_percent = 10 %}

{% for block in blocks %}
  {% assign total_steps = total_steps | plus: 1 %}
  {% if block.settings.handle == current_status_handle %}
    {% assign current_step_index = forloop.index %}
    {% assign progress_percent = block.settings.progress %}
  {% endif %}
{% endfor %}

{% comment %} Fallback if status not found in blocks {% endcomment %}
{% if current_step_index == 0 %}
  {% assign current_step_index = 1 %}
{% endif %}

<article class="song-card" data-song-card data-song-title="{{ commission_item.title | escape }}">
  <header class="song-card__header">
    <div class="song-card__order-info">
      <span class="song-card__eyebrow">Order {{ order.name }}</span>
      <h2 class="song-card__title">{{ commission_item.title }}</h2>
      <div class="song-card__meta">
        <span>{{ order.created_at | date: format: 'date' }}</span>
        {% if commission_item.variant.title != 'Default Title' %}
          <span>{{ commission_item.variant.title }}</span>
        {% endif %}
      </div>
    </div>
  </header>

  <div class="status-tracker">
    <div class="status-tracker__steps">
      {% for block in blocks %}
        {% assign step_status = 'pending' %}
        {% if forloop.index < current_step_index %}
          {% assign step_status = 'is-complete' %}
        {% elsif forloop.index == current_step_index %}
          {% assign step_status = 'is-active' %}
        {% endif %}

        <div class="status-step {{ step_status }}">
          <div class="status-step__dot">
            <svg class="status-step__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <span class="status-step__label">{{ block.settings.title }}</span>
        </div>
      {% endfor %}
    </div>

    <div class="status-tracker__progress-container">
      <div class="status-tracker__progress-bar" data-progress-bar data-width="{{ progress_percent }}" style="width: 0%"></div>
    </div>

    {% if status_message != blank %}
      <div class="status-message">
        <h3 class="status-message__heading">Update from Jeff</h3>
        <p class="status-message__text">{{ status_message }}</p>
      </div>
    {% endif %}
  </div>

  {% comment %} Lyrics Display Section {% endcomment %}
  {% assign lyrics_text = order.metafields.custom.lyrics_text | default: order.metafields.song_portal.lyrics_text %}
  {% assign show_lyrics_display = false %}
  
  {% if current_status_handle == 'writing_lyrics' or current_status_handle == 'lyrics_ready_for_review' or current_status_handle == 'lyrics_approved' or current_status_handle == 'recording_vocals' or current_status_handle == 'mixing_and_mastering' or current_status_handle == 'song_completed' %}
    {% assign show_lyrics_display = true %}
  {% endif %}

  {% if show_lyrics_display %}
    <div class="lyrics-display-section" id="lyrics-accordion">
      <button class="lyrics-display__header" aria-expanded="false" aria-controls="lyrics-content">
        <h3 class="lyrics-display__title">Your Lyrics</h3>
        <span class="lyrics-display__icon"></span>
      </button>
      
      <div id="lyrics-content" class="lyrics-display__content custom-scrollbar" aria-hidden="true">
        {% if lyrics_text != blank %}
          <div class="lyrics-text">
            {{ lyrics_text | newline_to_br }}
          </div>
        {% else %}
          <div class="lyrics-placeholder">
            <p>Your custom lyrics will appear here as soon as they are ready for review.</p>
          </div>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {% comment %} Lyrics Approval Section {% endcomment %}
  {% assign lyrics_file_url = order.metafields.custom.lyrics_file_url | default: order.metafields.song_portal.lyrics_file_url %}
  
  {% if current_status_handle == 'lyrics_ready_for_review' %}
    <div class="lyrics-approval-section">
      <div class="lyrics-approval__header">
        <h3 class="lyrics-approval__title">Approve Lyrics</h3>
        <p class="lyrics-approval__subtitle">Please review the lyrics above and let me know if you approve or would like changes.</p>
      </div>

      {% if lyrics_file_url != blank %}
        <div class="lyrics-file">
          <a href="{{ lyrics_file_url }}" target="_blank" class="btn-portal btn-portal--outline btn-lyrics-download" download>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <polyline points="9 15 12 18 15 15"></polyline>
            </svg>
            Download Lyrics Document
          </a>
        </div>
      {% endif %}

      <div class="approval-actions">
        <form class="lyrics-approval-form" data-lyrics-approval-form data-order-id="{{ order.id }}">
          <input type="hidden" name="order_id" value="{{ order.id }}">
          <input type="hidden" name="order_name" value="{{ order.name }}">
          <input type="hidden" name="customer_email" value="{{ customer.email }}">
          <input type="hidden" name="action" value="approve">
          <button type="submit" class="btn-portal btn-approve" data-approve-btn>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Approve Lyrics
          </button>
        </form>

        <button type="button" class="btn-portal btn-portal--outline btn-request-changes" data-show-changes>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Request Changes
        </button>
      </div>

      <div class="change-request-section" data-change-request-section style="display: none;">
        <form class="change-request-form" data-change-request-form data-order-id="{{ order.id }}">
          <input type="hidden" name="order_id" value="{{ order.id }}">
          <input type="hidden" name="order_name" value="{{ order.name }}">
          <input type="hidden" name="customer_email" value="{{ customer.email }}">
          <input type="hidden" name="action" value="request_changes">
          
          <label for="change-text-{{ order.id }}" class="change-request__label">
            What changes would you like to make?
          </label>
          <textarea 
            id="change-text-{{ order.id }}" 
            name="change_request" 
            class="change-request__textarea"
            rows="5" 
            placeholder="Please describe what you'd like changed in the lyrics. Be as specific as possible..."
            required
          ></textarea>
          
          <div class="form-actions">
            <button type="submit" class="btn-portal btn-submit-changes">
              Send Change Request
            </button>
            <button type="button" class="btn-portal btn-portal--ghost btn-cancel" data-cancel-changes>
              Cancel
            </button>
          </div>
        </form>
      </div>

      <div class="approval-feedback" data-approval-feedback style="display: none;"></div>
    </div>
  {% endif %}

  {% comment %} Song Approval Section - Ultra Premium Design {% endcomment %}
  <div class="song-approval-section lyrics-display-section">
    <div class="lyrics-display__header" style="cursor: default; border-bottom: none;">
      <h3 class="lyrics-display__title">Song Preview</h3>
    </div>

    <div class="audio-section" style="background: transparent; border: none; padding: 0 2rem 2rem; display: flex; flex-direction: column; align-items: center; gap: 2.5rem;">
      
      <!-- Premium Player Card -->
      <div class="premium-player-card">
        <div class="audio-player__wrapper">
          {% if preview_audio != blank %}
            <div class="player-header">
              <span class="audio-player__label">Preview Mix</span>
              <div class="live-indicator">
                <span class="dot"></span> Live
              </div>
            </div>
            
            <div class="custom-audio-player" data-audio-url="{{ preview_audio.url | default: preview_audio }}">
              <audio class="hidden-audio" preload="metadata">
                <source src="{{ preview_audio.url | default: preview_audio }}" type="audio/mpeg">
              </audio>
              
              <div class="player-controls">
                <button class="play-pause-btn" aria-label="Play">
                  <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  <svg class="icon-pause" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                  </svg>
                </button>
                
                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-fill"></div>
                  </div>
                  <div class="time-display">
                    <span class="current-time">0:00</span> / <span class="duration">0:00</span>
                  </div>
                </div>
              </div>
            </div>

          {% elsif final_audio != blank %}
             <div class="player-header">
               <span class="audio-player__label">Final Song</span>
               <div class="live-indicator">
                 <span class="dot"></span> Ready
               </div>
             </div>
             
             <div class="custom-audio-player" data-audio-url="{{ final_audio.url | default: final_audio }}">
              <audio class="hidden-audio" preload="metadata">
                <source src="{{ final_audio.url | default: final_audio }}" type="audio/mpeg">
              </audio>
              
              <div class="player-controls">
                <button class="play-pause-btn" aria-label="Play">
                  <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  <svg class="icon-pause" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                  </svg>
                </button>
                
                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-fill"></div>
                  </div>
                  <div class="time-display">
                    <span class="current-time">0:00</span> / <span class="duration">0:00</span>
                  </div>
                </div>
              </div>
            </div>

          {% else %}
            <span class="audio-player__label">Audio Preview</span>
            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.5); font-style: italic; text-align: center; padding: 1rem;">
              Your preview will appear here when ready.
            </div>
          {% endif %}
        </div>
      </div>


      <div class="audio-actions">
        {% if final_approved == true and current_status_handle != 'music_ready' %}
          {% comment %} APPROVED STATE: Show Download Only {% endcomment %}
          <div class="approval-success-message" style="text-align: center; margin-top: 1.5rem;">
            <p style="color: #4ade80; font-family: var(--font-heading); font-size: 1.2rem; margin-bottom: 1rem;">
              âœ“ Song Approved
            </p>
            {% if final_audio != blank %}
              <a href="{{ final_audio.url | default: final_audio }}" class="btn-portal" data-download-btn>
                Download Final Song
              </a>
            {% endif %}
          </div>

        {% elsif preview_audio != blank %}
          {% comment %} REVIEW STATE: Show Approve / Request Changes {% endcomment %}
          <!-- DEBUG: Preview Audio Found: {{ preview_audio }} -->
          
          <div class="approval-actions">
            <form class="song-approval-form" data-song-approval-form data-order-id="{{ order.id }}">
              <input type="hidden" name="order_id" value="{{ order.id }}">
              <input type="hidden" name="order_name" value="{{ order.name }}">
              <input type="hidden" name="customer_email" value="{{ customer.email }}">
              <input type="hidden" name="action" value="approve_song">
              <button type="submit" class="btn-portal btn-approve">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Approve Song
              </button>
            </form>

            <button type="button" class="btn-portal btn-portal--outline btn-request-changes" data-show-song-changes>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              Request Revisions
            </button>
          </div>

          <div class="change-request-section" data-song-change-section style="display: none;">
            <form class="song-change-form" data-song-change-form data-order-id="{{ order.id }}">
              <input type="hidden" name="order_id" value="{{ order.id }}">
              <input type="hidden" name="order_name" value="{{ order.name }}">
              <input type="hidden" name="customer_email" value="{{ customer.email }}">
              <input type="hidden" name="action" value="request_song_changes">
              
              <label for="song-change-text-{{ order.id }}" class="change-request__label">
                What revisions would you like?
              </label>
              <textarea 
                id="song-change-text-{{ order.id }}" 
                name="change_request" 
                class="change-request__textarea"
                rows="5" 
                placeholder="Please describe the changes you'd like to the mix, arrangement, or vocals..."
                required
              ></textarea>
              
              <div class="form-actions">
                <button type="submit" class="btn-portal btn-submit-changes">
                  Send Revisions
                </button>
                <button type="button" class="btn-portal btn-portal--ghost btn-cancel" data-cancel-song-changes>
                  Cancel
                </button>
              </div>
            </form>
          </div>

          <div class="approval-feedback" data-song-approval-feedback style="display: none;"></div>

        {% else %}
          {% comment %} LOCKED STATE {% endcomment %}
          <div style="text-align: center; margin-top: 1rem;">
            <button class="btn-portal btn-portal--outline" disabled style="opacity: 0.5; cursor: default;">
              Download Locked
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</article>
